#!/bin/sh

TOP_DIR=..

version="$1"
kernel_arch="$2"
dest_dir="$3/$1"

# Remove previous files at downloads/ dir
rm -Rf "$TOP_DIR/downloads/linux-headers-$version"
rm -Rf "$TOP_DIR/downloads/linux-headers-$version.orig"
rm  -f "$TOP_DIR/downloads/linux-headers-$version.tar.bz2"
rm  -f "$TOP_DIR/downloads/headers"

echo "Downloading the LFS headers script..."

pushd "$TOP_DIR/downloads" >& /dev/null
wget --quiet http://ftp.jg555.com/headers/headers
GrepReplace "\--quiet" "" headers && rm -f headers~
chmod +x headers
./headers "$version"
popd >& /dev/null

echo "Configuring headers for the $kernel_arch platform..."
pushd "$TOP_DIR/downloads/linux-headers-$version/include" >& /dev/null
for i in asm-*
do
    [ "$i" = "asm-$kernel_arch" -o "$i" = "asm-generic" ] && continue
    rm -Rf "$i"
done
popd >& /dev/null

echo "Installing headers on $dest_dir..."
pushd "$TOP_DIR/downloads" >& /dev/null
mkdir -p $dest_dir
mv linux-headers-$version/* $dest_dir
popd >& /dev/null

mkdir -p $dest_dir/include
pushd $dest_dir/include >& /dev/null
ln -nfs $version $dest_dir/../Current
ln -nfs "asm-$kernel_arch" asm
popd >& /dev/null

# for some reason, 'headers' is removing compiler.h from the package.
# let's reintroduce it.
cp "$TOP_DIR/downloads/linux-headers-$version.orig/include/linux/compiler.h" $dest_dir/include/linux

if [ -d $dest_dir/include/asm-sh ]
then
    # asm-sh/byteorder.h fails to recognize __attribute_const__ attribute.
    # fix that by including linux/compiler.h.
    GrepReplace "#include <asm/types.h>" \
        "#include <asm/types.h>\n#include <linux/compiler.h>" \
        $dest_dir/include/asm-sh/byteorder.h
fi
