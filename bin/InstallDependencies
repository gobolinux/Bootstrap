#!/bin/sh

TOP_DIR=..
export PATH=$PATH:$TOP_DIR/functions

source PkgFunctions
source ScriptFunctions
source $TOP_DIR/.config

#
# Fetch and install ChrootCompile in the private downloads dir
#
dirname="$TOP_DIR/downloads/ChrootCompile"
if [ ! -d "$dirname" ]
then
    Log_Normal "Fetching ChrootCompile from the CVS..."
    mkdir -p "$TOP_DIR/downloads"
    pushd "$TOP_DIR/downloads" >& /dev/null
    cvs_checkout ChrootCompile tools/ChrootCompile
    popd >& /dev/null
fi

dirname="$TOP_DIR/chroot/tools/ChrootCompile"
got_glibc=`ls $TOP_DIR/chroot/Bootstrap/Glibc--* 2> /dev/null`
if [ ! -d "$dirname" -o ! "$got_glibc" ]
then
    mkdir -p "$TOP_DIR/chroot"
    pushd "$TOP_DIR/chroot" >& /dev/null
    ../downloads/ChrootCompile/SetupChrootEnv
    popd >& /dev/null

    got_glibc=`ls $TOP_DIR/chroot/Bootstrap/Glibc--* 2> /dev/null`
    if [ ! "$got_glibc" ]
    then
        Log_Error "Could not get files from rsync"
        exit 1
    fi
fi

#
# Create the chroot environment
#
dirname="$TOP_DIR/chroot"
if [ ! -d "$dirname" ]
then
    Log_Normal "Creating the ChrootCompile environment..."
    mkdir -p "$dirname"
    pushd "$dirname" >& /dev/null
    SetupChrootEnv --quiet
    popd >& /dev/null
fi
