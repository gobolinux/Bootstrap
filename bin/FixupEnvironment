#!/bin/sh

#
# After the system is cross-compiled, ensure that we have a sane
# environment ready to be used.
# 
# Author: Lucas Correia Villa Real <lucasvr@gobolinux.org>
#

TOP_DIR=..
export PATH=$PATH:$TOP_DIR/functions

source PkgFunctions
source ScriptFunctions
source $TOP_DIR/.config


if [ "$CROSS_NONE" = "y" ]
then 
	# nothing to do
	exit 0
else
	[ "$CROSS_ARM"  = "y" ] && arch_conf=ARM
	[ "$CROSS_SH4"  = "y" ] && arch_conf=SH4
	
	source $goboSettings/Compile/Cross-$arch_conf.conf
	prefix="$crossPrefixDir"
fi

echo

#
# Create a new ld.so.conf
#
if [ -d "$prefix/$goboPrograms/Glibc/Settings" ]
then
	Log_Normal "Generating a new ld.so.cache..."
	echo "$prefix/$goboLibraries" > "$prefix/$goboPrograms/Glibc/Settings/ld.so.conf"
	ldconfig -f "$prefix/$goboPrograms/Glibc/Settings/ld.so.conf" \
    	     -C "$prefix/$goboPrograms/Glibc/Settings/ld.so.cache"
	ln -nfs "$prefix/$goboPrograms/Glibc/Settings/ld.so.conf"  "$prefix/$goboSettings"
	ln -nfs "$prefix/$goboPrograms/Glibc/Settings/ld.so.cache" "$prefix/$goboSettings"
fi

#
# Install the Tiny Scripts package
#
dirname="$prefix/$goboPrograms/Scripts"
if [ ! -d "$dirname" -a "$TARGET_EMBEDDED" = "y" ]
then
	dirname="$prefix/$goboPrograms/TinyScripts"
    tmpdir="$TOP_DIR/downloads/TinyScripts"
	Log_Normal "Installing the Tiny Scripts package..."
    cvs_checkout "$tmpdir" tools/TinyScripts
    cvs_make_install "$tmpdir" "$dirname" "`date +%Y%m%d`-CVS"
	rm "$tmpdir" -Rf
	RescueSymlinkProgram `readlink -f $dirname/Current` $prefix/$goboLinks >& /dev/null
fi
