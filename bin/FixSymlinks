#!/bin/sh

#
# Given a directory, remove (or add) a specific prefix to every symlink
# found.
# 
# Author: Lucas Correia Villa Real <lucasvr@gobolinux.org>
#

if [ $# -lt 1 ]; then
	echo "Syntax: $0 <basedir> <pattern> [-r]"
	echo "Example:"
    echo
    echo "$0 /Depot/ARM-Linux"
    echo "Removes references to /Depot/ARM-Linux from symlinks inside the current directory"
    echo
    echo "$0 /Depot/ARM-Linux -r"
    echo "Adds a prefix to /Depot/ARM-Linux on symlinks inside the current directory"
    echo
	exit 1
fi

base_dir="$1"

if [ "$2" = "-r" ]; then
	# appends the given prefix to existing symlinks
	for i in `find . -type l | grep -v Kernel`; do
		CURRLINK=`readlink $i`
		NEWLINK=`echo ${base_dir}${CURRLINK}`
		[ ! "$CURRLINK" = "$NEWLINK" ] && ln -nfs "$NEWLINK" "$i"
	done

    # TODO: GrepReplace
else
	# remove the given prefix from symlinks
	for i in `find . -type l | grep -v Kernel`; do
		CURRLINK=`readlink $i`
		NEWLINK=`echo $CURRLINK| sed "s%$base_dir%%"`
		[ ! "$CURRLINK" = "$NEWLINK" ] && {
            echo "CURR => $CURRLINK"
            echo "NEWLINK => $NEWLINK"
            echo
            ln -nfs "$NEWLINK" "$i"
        }
	done

    for i in `find Programs/*/Current/bin Programs/*/Current/lib Programs/*/Settings`; do
        GrepReplace "$base_dir" "" $i
    done
fi

