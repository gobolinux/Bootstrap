#!/bin/sh

#
# InvokeCompile: parses .config and runs Compile for each pkg selected there
#
# Author: Lucas Correia Villa Real <lucasvr@gobolinux.org>
#

TOP_DIR=..
dot_config=$TOP_DIR/.config
subdir=$TOP_DIR/packages

# GoboLinux Scripts' functions
source GoboPath
source ScriptFunctions

# Bootstrap's own functions
PATH=$PATH:$TOP_DIR/functions
source PkgFunctions
source BlackList

# Cross-compiling variables
source $dot_config

if [ "$CROSS_NONE" = "y" ]
then 
    prefix="$INSTALL_PREFIX"
else
    [ "$CROSS_ARM"  = "y" ] && export arch=ARM
    [ "$CROSS_SH4"  = "y" ] && export arch=SH4
	source $goboSettings/Compile/Cross-$arch.conf
    cross_options="--cross-compile $arch"
fi


pushd $subdir >& /dev/null

for entry in `cat $dot_config | grep "=y" | grep PKG`
do
    pkg_dir=`package_subdir $entry`
    [ ! -d "$pkg_dir" ] && continue

    pkg_name=`basename "$pkg_dir"`
	is_in_blacklist "$pkg_name" && continue

	if [ -d "$crossPrefixDir/$goboPrograms/$pkg_name" ]
	then
		Ask_Option "$pkg_name seems to be already compiled. Do you want to skip it? [Y/N]"
		case "$REPLY" in
	    	n|N) # compile it
		 		 ;;
	    	*)   continue 
		 		 ;;
		esac
	fi

	recipe=`get_recipe "$pkg_dir" "$pkg_name"`
	echo
	Log_Normal "Running 'Compile $cross_options $recipe'"
	echo
	Compile $cross_options $recipe || exit 1
done

popd >& /dev/null
