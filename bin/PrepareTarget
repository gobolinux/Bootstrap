#!/bin/sh

TOP_DIR=..
export PATH=$PATH:$TOP_DIR/functions

source PkgFunctions
source ScriptFunctions
source $TOP_DIR/.config

function cleanup() {
    cd "$TOP_DIR/bin"
    ./BootStrap stop
}

trap cleanup TERM INT STOP HUP

#
# Install the ChrootCompile package on the host's root system
#
dirname="$goboPrograms/ChrootCompile"
if [ ! -d "$dirname" ]
then
    pushd "$TOP_DIR/downloads" >& /dev/null
    Log_Normal "Installing the ChrootCompile package on the host system..."
    rm -Rf tools/ChrootCompile
    cvs_checkout ChrootCompile tools/ChrootCompile

    version="`date +%Y%m%d`-CVS"
    cvs_make_install ChrootCompile "$dirname" "$version" "VERSION=$version"
    SymlinkProgram ChrootCompile
    popd >& /dev/null
fi

if [ "$CROSS_NONE" = "y" ]
then 
	prefix="$INSTALL_PREFIX"
	kernelVersion="$KERNEL_VERSION"
else
	[ "$CROSS_ARM"  = "y" ] && export arch_conf=ARM
	[ "$CROSS_SH4"  = "y" ] && export arch_conf=SH4
	
	source $goboSettings/Compile/Cross-$arch_conf.conf
	prefix="$crossPrefixDir"
	symlink_options="-c overwrite"

	# needs to be propagated to Scripts
	export goboCrossCompiling=yes
fi

#
# Create the basic GoboLinux structure
#
if [ ! -d $prefix/$goboPrograms ]
then
    Log_Normal "Creating the GoboLinux tree..."
    CreateGoboLinuxTree $prefix $SUPER_USER_NAME || exit 1
fi

if [ ! -c $prefix/$goboDevices/console ]
then
    Log_Normal "Populating the device directory..."
    PopulateDev $prefix || exit 1
fi

#
# Create some system files
#
CreateFiles $SUPER_USER_NAME

#
# Install the Scripts package
#
dirname="$prefix/$goboPrograms/Scripts"
if [ ! -d "$dirname" -a "$TARGET_EMBEDDED" = "n" ]
then
	Log_Normal "Installing the Scripts package..."
	cp -a $goboPrograms/Scripts $prefix/$goboPrograms
	RescueSymlinkProgram `readlink -f $dirname/Current` $prefix/$goboLinks >& /dev/null
else
	Log_Normal "Symlinking the Scripts package..."
	ln -nsf $goboPrograms/Scripts $prefix/$goboPrograms
	RescueSymlinkProgram `readlink -f $dirname/Current` $prefix/$goboLinks >& /dev/null
fi

#
# Install the Compile package
#
dirname="$prefix/$goboPrograms/Compile"
if [ ! -d "$dirname" -a "$TARGET_EMBEDDED" = "n" ]
then
	Log_Normal "Installing the Compile package..."
	cp -a $goboPrograms/Compile $prefix/$goboPrograms
	RescueSymlinkProgram `readlink -f $dirname/Current` $prefix/$goboLinks >& /dev/null
else
	Log_Normal "Symlinking the Compile package..."
	ln -nsf $goboPrograms/Compile $prefix/$goboPrograms
	RescueSymlinkProgram `readlink -f $dirname/Current` $prefix/$goboLinks >& /dev/null
fi

#
# Install the BootScripts package
#
dirname="$prefix/$goboPrograms/BootScripts"
if [ ! -d "$dirname" -a "$TARGET_EMBEDDED" = "n" ]
then
	Log_Normal "Installing the BootScripts package..."
	cp -a $goboPrograms/BootScripts $prefix/$goboPrograms
	SymlinkProgram $symlink_options BootScripts >& /dev/null
fi

#
# Create a LibGCC package just to satisfy packages with 
# dependencies on libgcc_s.so
#
dirname="$prefix/$goboPrograms/LibGCC"
if [ "$PKG_LIBGCC" = "y" -a ! -d "$dirname" ]
then
	Log_Normal "Creating a LibGCC package..."
	if [ "$CROSS_NONE" = "y" ]
	then
		version=`gcc --version | head -n 1 | awk {'print $3'}`
		gcc_libdir=$goboPrograms/GCC
	else
		version=`$CC --version | head -n 1 | awk {'print $3'}`
	fi
	
    mkdir -p $dirname/$version/lib
    ln -sf $version $dirname/Current

    pushd $dirname/Current/lib >& /dev/null
    cp -a $gcc_libdir/libgcc* .
    popd >&/dev/null

    SymlinkProgram $symlink_options LibGCC >& /dev/null
fi

#
# Install the kernel modules
#
dirname="$prefix/$goboModules/$kernelVersion"
if [ ! -d "$dirname" ]
then
	Log_Normal "Compiling the Linux kernel..."
fi
