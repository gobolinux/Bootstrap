#!/bin/sh

#
# Given a directory, cleans it by removing data that's not necessary for the
# program's usage.
# 
# Author: Lucas Correia Villa Real <lucasvr@gobolinux.org>
#

if [ ! $# -eq 1 ]; then
	echo "Syntax: $0 <dir>"
	exit 1
fi

pushd "$1" >& /dev/null

FIND="find . -name"

echo "Removing static libraries and libtool .la files"
$FIND "*.a"             | xargs rm  -f >& /dev/null
$FIND "*.la"            | xargs rm  -f >& /dev/null

echo "Removing headers"
$FIND  include   -type d | xargs rm -Rf >& /dev/null

echo "Removing documentation"
$FIND man       -type d | xargs rm -Rf >& /dev/null
$FIND info      -type d | xargs rm -Rf >& /dev/null
$FIND doc       -type d | xargs rm -Rf >& /dev/null
$FIND gtk-doc   -type d | grep "Shared/gtk-doc"  | xargs rm -Rf >& /dev/null
$FIND gtk-2.0   -type d | grep "gtk-2.0/demo"    | xargs rm -Rf >& /dev/null

echo "Removing pkgconfig data"
$FIND pkgconfig -type d | xargs rm -Rf >& /dev/null

echo "Removing autoconf macros"
$FIND aclocal   -type d | xargs rm -Rf >& /dev/null

echo "Removing unused shared data"
$FIND emacs     -type d | grep "Shared/emacs"    | xargs rm -Rf >& /dev/null

echo "Removing internationalization data (except for pt_BR and pt_PT)"
$FIND locale    -type d | grep -v "locale/pt_BR" | grep -v "locale/pt_PT" | xargs rm -Rf >& /dev/null
$FIND gettext   -type d | grep "gettext/intl"    | xargs rm -Rf >& /dev/null
$FIND gettext   -type d | grep "gettext/projects"| xargs rm -Rf >& /dev/null

echo "Removing binary applications used at compile-time only"
rm -f Programs/LibPNG/Current/bin/*
rm -f Programs/JPEG/Current/bin/*
rm -f Programs/SDL/Current/bin/*
rm -f Programs/FreeType/Current/bin/*

rm -Rf System/Links/Headers/*
for i in `seq 1 8`; do
	rm -f System/Links/Manuals/man$i/*
done


#$FIND Resources -type d | xargs rm -Rf >& /dev/null

#for i in System/Links/Executables/*; do
#	readlink $i | grep BusyBox  >& /dev/null && continue
#	readlink $i | grep GoboHide >& /dev/null && continue
#	readlink $i | grep GPM      >& /dev/null && continue
#	readlink $i | grep Matchbox >& /dev/null && continue
#	readlink $i | grep RXVT     >& /dev/null && continue
#	readlink $i | grep Xserver  >& /dev/null && continue
#	echo "Removing $i"
#	rm -f $i
#done

# Remove empty dirs
echo "Removing empty directories"
find . -type d | xargs rmdir >& /dev/null

echo "Removing broken links"
find . | RemoveBroken
popd >& /dev/null
